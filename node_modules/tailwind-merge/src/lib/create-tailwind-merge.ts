import { createConfigUtils } from './config-utils'
import { mergeClassList } from './merge-classlist'
import { ClassNameValue, twJoin } from './tw-join'
import { AnyConfig } from './types'

type CreateConfigFirst = () => AnyConfig
type CreateConfigSubsequent = (config: AnyConfig) => AnyConfig
type TailwindMerge = (...classLists: ClassNameValue[]) => string
type ConfigUtils = ReturnType<typeof createConfigUtils>

<<<<<<< HEAD
export function createTailwindMerge(
    createConfigFirst: CreateConfigFirst,
    ...createConfigRest: CreateConfigSubsequent[]
): TailwindMerge {
    let configUtils: ConfigUtils
    let cacheGet: ConfigUtils['cache']['get']
    let cacheSet: ConfigUtils['cache']['set']
    let functionToCall = initTailwindMerge

    function initTailwindMerge(classList: string) {
=======
export const createTailwindMerge = (
    createConfigFirst: CreateConfigFirst,
    ...createConfigRest: CreateConfigSubsequent[]
): TailwindMerge => {
    let configUtils: ConfigUtils
    let cacheGet: ConfigUtils['cache']['get']
    let cacheSet: ConfigUtils['cache']['set']
    let functionToCall: (classList: string) => string

    const initTailwindMerge = (classList: string) => {
>>>>>>> 7e787996e344ec0e38973ffd84b2419f9c179aec
        const config = createConfigRest.reduce(
            (previousConfig, createConfigCurrent) => createConfigCurrent(previousConfig),
            createConfigFirst() as AnyConfig,
        )

        configUtils = createConfigUtils(config)
        cacheGet = configUtils.cache.get
        cacheSet = configUtils.cache.set
        functionToCall = tailwindMerge

        return tailwindMerge(classList)
    }

<<<<<<< HEAD
    function tailwindMerge(classList: string) {
=======
    const tailwindMerge = (classList: string) => {
>>>>>>> 7e787996e344ec0e38973ffd84b2419f9c179aec
        const cachedResult = cacheGet(classList)

        if (cachedResult) {
            return cachedResult
        }

        const result = mergeClassList(classList, configUtils)
        cacheSet(classList, result)

        return result
    }

<<<<<<< HEAD
    return function callTailwindMerge() {
        return functionToCall(twJoin.apply(null, arguments as any))
    }
=======
    functionToCall = initTailwindMerge

    return (...args: ClassNameValue[]) => functionToCall(twJoin(...args))
>>>>>>> 7e787996e344ec0e38973ffd84b2419f9c179aec
}
