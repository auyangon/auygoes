name: Build and Publish Docker

on:
  push:
    branches:
      - main
    paths:
      - 'client/**'
      - 'src/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/build_and_publish.yaml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3) - leave empty for auto-increment'
        required: false
        type: string

permissions:
  contents: write # required for creating releases

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Determine version
        id: version
        shell: pwsh
        run: |
          # Check if version was manually provided
          $manualVersion = "${{ github.event.inputs.version }}"
          
          if ($manualVersion) {
            $newVersion = $manualVersion
            Write-Host "Using manually provided version: $newVersion"
          }
          else {
            # Auto-increment from Docker Hub
            $response = Invoke-RestMethod -Uri "https://hub.docker.com/v2/repositories/${{ vars.DOCKERHUB_USERNAME }}/publicq-app/tags/?page_size=100"
            
            $versions = @($response.results.name | Where-Object { $_ -match '^\d+\.\d+\.\d+$' })
            
            if ($versions.Count -eq 0) {
              $newVersion = "1.0.0"
              Write-Host "No existing versions found. Starting with: $newVersion"
            }
            else {
              $sortedVersions = @($versions | Sort-Object { [version]$_ })
              $latest = $sortedVersions[$sortedVersions.Count - 1]
              Write-Host "Latest version found: $latest"
              Write-Host "Latest version type: $($latest.GetType().Name)"
              
              $parts = $latest.ToString().Split('.')
              $major = [int]$parts[0]
              $minor = [int]$parts[1]
              $patch = [int]$parts[2] + 1
              
              $newVersion = "$major.$minor.$patch"
              Write-Host "Auto-incremented version: $newVersion"
            }
          }
          
          "new_version=$newVersion" >> $env:GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker images
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.new_version }}"
          docker build -t ${{ vars.DOCKERHUB_USERNAME }}/publicq-app:latest -t ${{ vars.DOCKERHUB_USERNAME }}/publicq-app:$version .
          docker push ${{ vars.DOCKERHUB_USERNAME }}/publicq-app:latest
          docker push ${{ vars.DOCKERHUB_USERNAME }}/publicq-app:$version

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          generate_release_notes: true
          body: |
            Docker images published:
            - `${{ vars.DOCKERHUB_USERNAME }}/publicq-app:latest`
            - `${{ vars.DOCKERHUB_USERNAME }}/publicq-app:${{ steps.version.outputs.new_version }}`